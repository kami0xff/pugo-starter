{{ define "main" }}
{{/* Check if this is a standalone content page (has content but no children) */}}
{{ $hasContent := gt (len .Content) 0 }}
{{ $pageCount := len .Pages }}
{{ $sectionCount := len .Sections }}
{{ $hasChildren := or (gt $pageCount 0) (gt $sectionCount 0) }}

{{ if and $hasContent (not $hasChildren) }}
{{/* Render as a standalone article page with sidebar */}}
<div class="help-layout" id="helpLayout">
  <!-- Sidebar with help topics -->
  {{ partial "sidebar-standalone.html" . }}

  <!-- Main Content -->
  <main class="help-main">
    <!-- Toolbar -->
    <div class="help-toolbar">
      <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
        <svg class="icon-menu" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="18" height="18" x="3" y="3" rx="2"/>
          <path d="M9 3v18"/>
        </svg>
        <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="18" height="18" x="3" y="3" rx="2"/>
          <path d="M9 3v18"/>
          <path d="m14 9 3 3-3 3"/>
        </svg>
        <span class="toggle-label">Navigation</span>
      </button>
      
      <a href="/" class="back-home">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Back to Help Center
      </a>
    </div>

    <!-- Article Content Area -->
    <div class="article-wrapper">
      <article class="article-content" data-pagefind-body data-pagefind-filter="language:{{ .Site.Language.Lang }}">
        <!-- Breadcrumbs -->
        <nav class="article-breadcrumbs">
          <a href="/">Help Center</a>
          <span class="sep">/</span>
          <span>{{ .Title }}</span>
        </nav>

        <!-- Header -->
        <header class="article-header">
          <h1>{{ .Title }}</h1>
          {{ with .Description }}<p class="article-lead">{{ . }}</p>{{ end }}
        </header>

        <!-- Body -->
        <div class="article-body" id="articleBody">
          {{ .Content }}
        </div>

        <!-- Contact Support -->
        <div class="contact-support">
          <div class="contact-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="contact-text">
            <strong>Still need help?</strong>
            <span>Our support team is available 24/7 to assist you.</span>
          </div>
          <a href="{{ .Site.Params.liveChatUrl }}" target="_blank" rel="noopener" class="contact-btn">
            Contact Support
          </a>
        </div>
      </article>

      <!-- Table of Contents (Right Side) -->
      <aside class="article-toc" id="articleToc">
        <div class="toc-inner">
          <div class="toc-header">
            <span class="toc-label">On this page</span>
          </div>
          <nav class="toc-nav" id="tocNav">
            <!-- Populated by JS -->
          </nav>
        </div>
      </aside>
    </div>

    <!-- Footer Links -->
    <footer class="help-footer">
      <a href="{{ "contact/" | relLangURL }}">Contact Support</a>
      <a href="{{ "privacy/" | relLangURL }}">Privacy Policy</a>
      <a href="{{ "terms/" | relLangURL }}">Terms of Service</a>
    </footer>
  </main>
</div>

<style>
  /* Article with Sidebar Layout */
  .article-wrapper {
    display: flex;
    justify-content: center;
    gap: 3rem;
    padding: 2rem;
    width: 100%;
  }

  .article-content {
    flex: 0 1 720px;
    min-width: 0;
    max-width: 720px;
  }

  /* Table of Contents (Right Side) */
  .article-toc {
    width: 200px;
    flex-shrink: 0;
    display: none;
  }

  @media (min-width: 1280px) {
    .article-toc {
      display: block;
    }
  }

  .toc-inner {
    position: sticky;
    top: calc(var(--navbar-height) + 2rem);
  }

  .toc-header {
    margin-bottom: 1rem;
  }

  .toc-label {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #52525b;
  }

  .toc-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    border-left: 1px solid #27272a;
    padding-left: 1rem;
    margin-left: 0.25rem;
  }

  .toc-link,
  .toc-link:hover {
    font-size: 0.8125rem;
    color: #71717a;
    line-height: 1.5;
    padding: 0.25rem 0;
    transition: color 0.15s;
    position: relative;
    text-decoration: none !important;
  }

  .toc-link:hover {
    color: #a1a1aa;
  }

  .toc-link.active {
    color: #ef4444;
  }

  .toc-link.active::before {
    content: '';
    position: absolute;
    left: calc(-1rem - 1px);
    top: 0;
    bottom: 0;
    width: 2px;
    background: #ef4444;
  }

  .toc-link.toc-h3 {
    padding-left: 0.75rem;
    font-size: 0.75rem;
  }

  /* Breadcrumbs */
  .article-breadcrumbs {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: #52525b;
    margin-bottom: 2rem;
  }

  .article-breadcrumbs a,
  .article-breadcrumbs a:hover {
    color: #52525b;
    transition: color 0.15s;
    text-decoration: none !important;
  }

  .article-breadcrumbs a:hover {
    color: #a1a1aa;
  }

  .article-breadcrumbs .sep {
    color: #3f3f46;
  }

  /* Header */
  .article-header {
    margin-bottom: 2.5rem;
  }

  .article-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    line-height: 1.25;
    letter-spacing: -0.02em;
    margin-bottom: 0.75rem;
  }

  @media (min-width: 640px) {
    .article-header h1 {
      font-size: 2.25rem;
    }
  }

  .article-lead {
    font-size: 1.0625rem;
    color: #a1a1aa;
    line-height: 1.6;
  }

  /* Article Body */
  .article-body {
    font-size: 1rem;
    line-height: 1.8;
    color: rgba(255, 255, 255, 0.8);
  }

  .article-body h2 {
    font-size: 1.375rem;
    font-weight: 600;
    color: white;
    margin: 2.5rem 0 1rem;
    padding-top: 1.5rem;
    scroll-margin-top: calc(var(--navbar-height) + 1rem);
  }

  .article-body h2:first-child {
    margin-top: 0;
    padding-top: 0;
  }

  .article-body h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: white;
    margin: 2rem 0 0.75rem;
    scroll-margin-top: calc(var(--navbar-height) + 1rem);
  }

  .article-body p {
    margin-bottom: 1.25rem;
  }

  .article-body ul,
  .article-body ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .article-body li {
    margin-bottom: 0.375rem;
  }

  .article-body strong {
    color: white;
    font-weight: 600;
  }

  .article-body a {
    color: #6b9eff;
    text-decoration: none;
  }

  .article-body a:hover {
    color: #93b8ff;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 3px;
  }

  .article-body hr {
    border: none;
    border-top: 1px solid #1f1f23;
    margin: 2rem 0;
  }

  /* Contact Support Card */
  .contact-support {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin-top: 3rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, rgba(127, 29, 29, 0.12) 0%, rgba(0, 0, 0, 0.2) 100%);
    border: 1px solid rgba(127, 29, 29, 0.2);
    border-radius: 0.75rem;
  }

  .contact-icon {
    width: 2.75rem;
    height: 2.75rem;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ef4444;
    flex-shrink: 0;
  }

  .contact-text {
    flex: 1;
    min-width: 180px;
  }

  .contact-text strong {
    display: block;
    font-weight: 600;
    color: white;
    font-size: 0.9375rem;
    margin-bottom: 0.125rem;
  }

  .contact-text span {
    font-size: 0.8125rem;
    color: #71717a;
  }

  .contact-btn,
  .contact-btn:hover,
  .contact-btn:focus,
  .contact-btn:active {
    padding: 0.625rem 1.25rem;
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    font-weight: 500;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    text-decoration: none !important;
    transition: all 0.15s;
  }

  .contact-btn:hover {
    background: rgba(239, 68, 68, 0.25);
    border-color: rgba(239, 68, 68, 0.5);
    color: #f87171;
  }

  /* Sidebar toggle always visible */
  .help-layout .sidebar-toggle {
    display: flex !important;
  }

  .help-layout .sidebar-toggle .toggle-label {
    display: none;
  }

  @media (min-width: 640px) {
    .help-layout .sidebar-toggle .toggle-label {
      display: inline;
    }
  }

  /* Desktop: sidebar panel toggle icons */
  @media (min-width: 1024px) {
    .help-layout .sidebar-toggle .icon-close {
      display: none;
    }

    .help-layout .sidebar-toggle .icon-menu {
      display: block;
    }

    .help-layout.sidebar-hidden .sidebar-toggle .icon-close {
      display: block;
    }

    .help-layout.sidebar-hidden .sidebar-toggle .icon-menu {
      display: none;
    }

    /* Hide sidebar state */
    .help-layout.sidebar-hidden .sidebar {
      transform: translateX(-100%);
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .help-layout.sidebar-hidden .help-main {
      margin-left: 0;
    }

    /* Smooth transition */
    .help-layout .sidebar {
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .help-layout .help-main {
      transition: margin-left 0.25s ease;
    }
  }

  /* Mobile: original open/close behavior */
  @media (max-width: 1023px) {
    .help-layout .sidebar-toggle .icon-close {
      display: none;
    }

    .help-layout .sidebar-toggle .icon-menu {
      display: block;
    }

    .help-layout .sidebar.open ~ .help-main .sidebar-toggle .icon-menu {
      display: none;
    }

    .help-layout .sidebar.open ~ .help-main .sidebar-toggle .icon-close {
      display: block;
    }
  }

  /* Ensure back link has no underline */
  .help-toolbar .back-home,
  .help-toolbar .back-home:hover {
    text-decoration: none !important;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .article-wrapper {
      padding: 1.5rem 1rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Sidebar toggle (works on all screen sizes)
    const helpLayout = document.getElementById('helpLayout');
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebarToggle');
    const storageKey = 'sidebar-hidden';

    if (toggle && helpLayout) {
      // Restore sidebar state from localStorage (desktop only)
      if (window.innerWidth >= 1024) {
        const isHidden = localStorage.getItem(storageKey) === 'true';
        if (isHidden) {
          helpLayout.classList.add('sidebar-hidden');
        }
      }

      toggle.addEventListener('click', () => {
        if (window.innerWidth >= 1024) {
          // Desktop: toggle hidden state
          helpLayout.classList.toggle('sidebar-hidden');
          const isNowHidden = helpLayout.classList.contains('sidebar-hidden');
          localStorage.setItem(storageKey, isNowHidden);
        } else {
          // Mobile: toggle open state
          sidebar?.classList.toggle('open');
          document.body.classList.toggle('sidebar-open');
        }
      });
    }

    // Build Table of Contents
    const articleBody = document.getElementById('articleBody');
    const tocNav = document.getElementById('tocNav');

    if (articleBody && tocNav) {
      const headings = articleBody.querySelectorAll('h2, h3');

      headings.forEach((heading, index) => {
        if (!heading.id) {
          heading.id = 'section-' + index;
        }

        const link = document.createElement('a');
        link.href = '#' + heading.id;
        link.className = 'toc-link toc-' + heading.tagName.toLowerCase();
        link.textContent = heading.textContent;

        link.addEventListener('click', function (e) {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'smooth' });
        });

        tocNav.appendChild(link);
      });

      // Highlight active section on scroll
      const tocLinks = tocNav.querySelectorAll('.toc-link');

      function updateActiveLink() {
        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentIndex = 0;
        const scrollBottom = window.scrollY + window.innerHeight;
        const pageHeight = document.documentElement.scrollHeight;
        const isAtBottom = scrollBottom >= pageHeight - 100;

        if (isAtBottom) {
          currentIndex = headings.length - 1;
        } else {
          headings.forEach((heading, index) => {
            if (heading.getBoundingClientRect().top <= 120) {
              currentIndex = index;
            }
          });

          const firstHeadingTop = headings[0].getBoundingClientRect().top;
          if (firstHeadingTop > 120) {
            currentIndex = 0;
          }
        }

        tocLinks.forEach((link, index) => {
          link.classList.toggle('active', index === currentIndex);
        });
      }

      window.addEventListener('scroll', updateActiveLink, { passive: true });
      updateActiveLink();
    }
  });
</script>

{{ else }}
{{/* Render as a list page with child pages */}}
<div class="help-layout">
  <!-- Sidebar -->
  {{ partial "sidebar.html" . }}

  <!-- Main Content -->
  <main class="help-main" data-pagefind-body data-pagefind-filter="language:{{ .Site.Language.Lang }}">
    <div class="help-toolbar">
      <button class="sidebar-toggle" id="sidebarToggle">
        <svg class="icon-menu" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" x2="21" y1="12" y2="12"></line>
          <line x1="3" x2="21" y1="6" y2="6"></line>
          <line x1="3" x2="21" y1="18" y2="18"></line>
        </svg>
        <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        <span class="toggle-label">Topics</span>
      </button>
      {{ $backLink := "/" }}
      {{ $backText := "Home" }}
      {{ with .Parent }}
      {{ if not .IsHome }}
      {{ $backLink = .RelPermalink }}
      {{ $backText = .Title }}
      {{ end }}
      {{ end }}
      <a href="{{ $backLink }}" class="back-home">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Back to {{ $backText }}
      </a>
    </div>

    <div class="help-content">
      <!-- Breadcrumbs -->
      <nav class="breadcrumbs">
        <a href="/">Help Center</a>
        {{ range .Ancestors.Reverse }}
        {{ if not .IsHome }}
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m9 18 6-6-6-6"/>
        </svg>
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        {{ end }}
        {{ end }}
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m9 18 6-6-6-6"/>
        </svg>
        <span>{{ .Title }}</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <h1 class="page-title">{{ .Title }}</h1>
        {{ with .Description }}<p class="page-desc">{{ . }}</p>{{ end }}
      </header>

      <!-- Articles in this section -->
      {{ if .Pages }}
      <div class="topic-grid" style="display: flex; flex-direction: column; gap: 0.5rem;">
        {{ range .Pages }}
        <a href="{{ .RelPermalink }}" class="related-link">
          <span>{{ .Title }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </a>
        {{ end }}
      </div>
      {{ else }}
      <p style="color: #71717a; text-align: center; padding: 3rem 0;">No articles available yet.</p>
      {{ end }}
    </div>

    <!-- Footer Links -->
    <footer class="help-footer">
      <a href="{{ "contact/" | relLangURL }}">{{ if eq .Site.Language.Lang "fr" }}Contacter le support{{ else }}Contact Support{{ end }}</a>
      <a href="{{ "privacy/" | relLangURL }}">{{ if eq .Site.Language.Lang "fr" }}Politique de confidentialit√©{{ else }}Privacy Policy{{ end }}</a>
      <a href="{{ "terms/" | relLangURL }}">{{ if eq .Site.Language.Lang "fr" }}Conditions d'utilisation{{ else }}Terms of Service{{ end }}</a>
    </footer>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const toggle = document.getElementById('sidebarToggle');
  
  if (toggle && sidebar) {
    toggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      document.body.classList.toggle('sidebar-open');
    });
  }
  
  // Category switcher
  const switcher = document.getElementById('categorySwitcher');
  const switcherParent = switcher?.closest('.sidebar-switcher');
  const categoryMenu = document.getElementById('categoryMenu');
  
  if (switcher && switcherParent && categoryMenu) {
    switcher.addEventListener('click', (e) => {
      e.stopPropagation();
      // Position the dropdown below the button
      const rect = switcher.getBoundingClientRect();
      categoryMenu.style.top = (rect.bottom + 8) + 'px';
      categoryMenu.style.left = rect.left + 'px';
      categoryMenu.style.width = rect.width + 'px';
      switcherParent.classList.toggle('open');
    });
    
    document.addEventListener('click', (e) => {
      if (!switcherParent.contains(e.target)) {
        switcherParent.classList.remove('open');
      }
    });
  }
});
</script>
{{ end }}
{{ end }}
